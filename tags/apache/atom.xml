<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Tag: Apache | GeekerProbe]]></title>
  <link href="http://blog.wtlucky.com/tags/apache/atom.xml" rel="self"/>
  <link href="http://blog.wtlucky.com/"/>
  <updated>2016-09-29T10:51:03+08:00</updated>
  <id>http://blog.wtlucky.com/</id>
  <author>
    <name><![CDATA[wtlucky ]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[APNS服务器搭建ssl错误问题解决方案]]></title>
    <link href="http://blog.wtlucky.com/blog/2013/02/27/apns-ssl-error/"/>
    <updated>2013-02-27T21:37:00+08:00</updated>
    <id>http://blog.wtlucky.com/blog/2013/02/27/apns-ssl-error</id>
    <content type="html"><![CDATA[<p>最近再做一个推送项目，需要搭建<code>APNS</code>服务器，再将PHP代码部署到<code>Server</code>上时遇到了如下错误：
{% codeblock APNS ssl error %}
Warning: stream_socket_client() [function.stream-socket-client]: Unable to set local cert chain file `ck.pem'; Check that your cafile/capath settings include details of your certificate and its issuer in D:\AppServ\www\push1\push.php on line 24</p>

<p>Warning: stream_socket_client() [function.stream-socket-client]: failed to create an SSL handle in D:\AppServ\www\push1\push.php on line 24</p>

<p>Warning: stream_socket_client() [function.stream-socket-client]: Failed to enable crypto in D:\AppServ\www\push1\push.php on line 24</p>

<p>Warning: stream_socket_client() [function.stream-socket-client]: unable to connect to ssl://gateway.sandbox.push.apple.com:2195 (Unknown error) in D:\AppServ\www\push1\push.php on line 24
Failed to connect: 0
{% endcodeblock %}</p>

<p>上网Google之，发现很多人遇到此问题，给出的解决方案照做后错误依然存在。
最终还是自己解决，从问题本身出发吧，自己当初调试时<code>Server</code>是部署在<code>Mac os</code>上的，而现在却要部署在<code>Windows Server 2008</code>上。所以很可能是两边的配置出了问题，而代码的第24行为：
{% codeblock lang:php %}
&lt;?php
$fp = stream_socket_client(
        &lsquo;ssl://gateway.sandbox.push.apple.com:2195&rsquo;, $err,
        $errstr, 60, STREAM_CLIENT_CONNECT|STREAM_CLIENT_PERSISTENT, $ctx);
?>
{% endcodeblock %}
<code>PHP</code>给出的错误大概是说，没有找到证书，无法建立ssl连接。</p>

<!--More -->


<p>首先<code>.pem</code>证书已经制作，并且可用。还有就是证书的路径需要放正确
{% codeblock lang:php %}
&lt;?php
stream_context_set_option($ctx, &lsquo;ssl&rsquo;, &lsquo;local_cert&rsquo;,$this->localcert);
?>
{% endcodeblock %}
确保该函数的最后一个参数所指的路径能正确找到证书。
经过测试在<code>Mac OS</code>下这样就可以了，但是在<code>Windows</code>下要改成这样：
{% codeblock lang:php %}
&lt;?php
stream_context_set_option($ctx, &lsquo;ssl&rsquo;, &lsquo;local_cert&rsquo;,dirname(<strong>FILE</strong>) . &lsquo;\&rsquo; .$this->localcert);
?>
{% endcodeblock %}</p>

<p>但是做了这些，问题仍然不能解决，剩下的问题就是<code>Apache</code>需要开启<code>ssl</code>模块，通过查看<code>Apache</code>的<a href="http://httpd.apache.org/docs/2.2/howto/ssi.html">官方文档</a>得知，使用<code>ssl</code>需要<code>Apache</code>开启三个支持模块分别是：</p>

<ol>
<li>mod_include</li>
<li>mod_cgi</li>
<li>mod_expires</li>
</ol>


<p>接下来打开<code>Apache</code>的配置文件<code>httpd.conf</code>大概50-100行之间模块加载部分，放开这三个模块加载前的注释：
{% codeblock lang:apache %}
LoadModule reqtimeout_module libexec/apache2/mod_reqtimeout.so
LoadModule ext_filter_module libexec/apache2/mod_ext_filter.so
LoadModule include_module libexec/apache2/mod_include.so          #注释放开
LoadModule filter_module libexec/apache2/mod_filter.so
LoadModule substitute_module libexec/apache2/mod_substitute.so
LoadModule deflate_module libexec/apache2/mod_deflate.so
LoadModule log_config_module libexec/apache2/mod_log_config.so
LoadModule log_forensic_module libexec/apache2/mod_log_forensic.so
LoadModule logio_module libexec/apache2/mod_logio.so
LoadModule env_module libexec/apache2/mod_env.so
LoadModule mime_magic_module libexec/apache2/mod_mime_magic.so
LoadModule cern_meta_module libexec/apache2/mod_cern_meta.so
LoadModule expires_module libexec/apache2/mod_expires.so         #注释放开
LoadModule headers_module libexec/apache2/mod_headers.so
LoadModule ident_module libexec/apache2/mod_ident.so
{% endcodeblock %}</p>

<p>保存，重启<code>Apache</code>，再试，问题已解决。</p>

<p>最后附上推送部分的<code>PHP</code>代码：
{% include_code php/push.php %}</p>
]]></content>
  </entry>
  
</feed>
